name: Haru Mail Backend CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          
      - name: ğŸ”§ Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-disabled: false
          
      - name: ğŸ”‘ Grant execute permission to gradlew
        run: chmod +x gradlew
        
      - name: ğŸ—ï¸ Build with Gradle
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REDIRECT_URI: ${{ secrets.GOOGLE_REDIRECT_URI }}
          SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
          SPRING_DATASOURCE_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
        run: |
          echo "ğŸ—ï¸ Starting Gradle buildâ€¦"
          ./gradlew clean build -x test
          echo "âœ… Build completed successfully!"

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸš€ Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          port: 22
          timeout: 300
          command_timeout: 600
          debug: true
          envs: GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,GOOGLE_REDIRECT_URI,SPRING_DATASOURCE_URL,SPRING_DATASOURCE_USERNAME,DB_PASSWORD,JWT_SECRET_KEY,REDIS_PASSWORD,MAIL_USERNAME,MAIL_PASSWORD,CLOUDINARY_API_KEY,CLOUDINARY_API_SECRET
          script: |
            set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¢…ë£Œ
            
            echo "ğŸ¯ ===== ë°°í¬ ì‹œì‘ ====="
            echo "ğŸ“… ë°°í¬ ì‹œê°„: $(date)"
            echo "ğŸ  í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
            echo "ğŸ‘¤ í˜„ì¬ ì‚¬ìš©ì: $(whoami)"
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            echo "ğŸ“ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ì¤‘â€¦"
            cd ~/Haru-Mail-Backend || {
              echo "âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ~/Haru-Mail-Backend"
              echo "ğŸ“‚ í˜„ì¬ í™ˆ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
              ls -la ~/
              exit 1
            }
            
            # Git ìƒíƒœ í™•ì¸ ë° ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ“¦ Git ìƒíƒœ í™•ì¸ ë° ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
            echo "ğŸ”„ í˜„ì¬ Git ìƒíƒœ:"
            git status --porcelain
            
            echo "ğŸ”„ í•˜ë“œ ë¦¬ì…‹ ì‹¤í–‰ ì¤‘..."
            git reset --hard HEAD || {
              echo "âŒ Git reset ì‹¤íŒ¨"
              exit 1
            }
            
            echo "â¬‡ï¸ ìµœì‹  ì½”ë“œ Pull ì¤‘..."
            git pull origin main || {
              echo "âŒ Git pull ì‹¤íŒ¨"
              echo "ğŸ” Git ìƒíƒœ í™•ì¸:"
              git status
              echo "ğŸ” ì›ê²© ì €ì¥ì†Œ í™•ì¸:"
              git remote -v
              exit 1
            }
            
            echo "âœ… ì½”ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
            echo "ğŸ“‹ ìµœì‹  ì»¤ë°‹ ì •ë³´:"
            git log --oneline -1
            
            # Gradle ë¹Œë“œ
            echo "ğŸ”¨ Gradle ë¹Œë“œ ì‹œì‘..."
            ./gradlew clean build -x test || {
              echo "âŒ Gradle ë¹Œë“œ ì‹¤íŒ¨"
              echo "ğŸ” Gradle ë²„ì „ í™•ì¸:"
              ./gradlew --version
              echo "ğŸ” Java ë²„ì „ í™•ì¸:"
              java -version
              exit 1
            }
            
            # JAR íŒŒì¼ í™•ì¸
            echo "ğŸ“¦ JAR íŒŒì¼ í™•ì¸ ì¤‘..."
            echo "ğŸ“‚ build/libs ë””ë ‰í† ë¦¬ ë‚´ìš©:"
            ls -la build/libs/
            
            JAR_FILE=$(find build/libs -name "*.jar" -not -name "*-plain.jar" | head -1)
            if [ -z "$JAR_FILE" ]; then
              echo "âŒ ì‹¤í–‰ ê°€ëŠ¥í•œ JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              echo "ğŸ“‚ ì‚¬ìš© ê°€ëŠ¥í•œ íŒŒì¼ë“¤:"
              find build/libs -name "*.jar"
              exit 1
            fi
            
            echo "âœ… JAR íŒŒì¼ ë°œê²¬: $JAR_FILE"
            echo "ğŸ“ JAR íŒŒì¼ í¬ê¸°: $(du -h "$JAR_FILE" | cut -f1)"
            
            # ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ
            echo "ğŸ”„ ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ ì¤‘..."
            JAVA_PID=$(pgrep -f 'java.*Haru-Mail-Backend' 2>/dev/null || echo "")
            
            if [ -n "$JAVA_PID" ]; then
              echo "ğŸ” ê¸°ì¡´ Java í”„ë¡œì„¸ìŠ¤ ë°œê²¬: PID $JAVA_PID"
              echo "â¹ï¸ ì •ìƒ ì¢…ë£Œ ì‹œë„ ì¤‘..."
              kill "$JAVA_PID" || echo "âš ï¸ ì •ìƒ ì¢…ë£Œ ì‹¤íŒ¨"
              
              # ì¢…ë£Œ ëŒ€ê¸°
              for i in {1..15}; do
                if ! kill -0 "$JAVA_PID" 2>/dev/null; then
                  echo "âœ… í”„ë¡œì„¸ìŠ¤ ì •ìƒ ì¢…ë£Œë¨"
                  break
                fi
                echo "â³ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ëŒ€ê¸° ì¤‘... ($i/15)"
                sleep 2
              done
              
              # ê°•ì œ ì¢…ë£Œ í™•ì¸
              if kill -0 "$JAVA_PID" 2>/dev/null; then
                echo "âš ï¸ ê°•ì œ ì¢…ë£Œ ì‹¤í–‰ ì¤‘..."
                kill -9 "$JAVA_PID" || echo "âŒ ê°•ì œ ì¢…ë£Œ ì‹¤íŒ¨"
                sleep 2
              fi
            else
              echo "â„¹ï¸ ì‹¤í–‰ ì¤‘ì¸ Java í”„ë¡œì„¸ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
            fi
            
            # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
            echo "ğŸ”§ í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì¤‘..."
            export GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID"
            export GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET"
            export GOOGLE_REDIRECT_URI="$GOOGLE_REDIRECT_URI"
            export SPRING_DATASOURCE_URL="$SPRING_DATASOURCE_URL"
            export SPRING_DATASOURCE_USERNAME="$SPRING_DATASOURCE_USERNAME"
            export DB_PASSWORD="$DB_PASSWORD"
            export JWT_SECRET_KEY="$JWT_SECRET_KEY"
            export REDIS_PASSWORD="$REDIS_PASSWORD"
            export MAIL_USERNAME="$MAIL_USERNAME"
            export MAIL_PASSWORD="$MAIL_PASSWORD"
            export CLOUDINARY_API_KEY="$CLOUDINARY_API_KEY"
            export CLOUDINARY_API_SECRET="$CLOUDINARY_API_SECRET"
            
            # í™˜ê²½ë³€ìˆ˜ ê²€ì¦ (ë¯¼ê°ì •ë³´ ì œì™¸)
            echo "ğŸ” í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ì¤‘..."
            if [ -z "$GOOGLE_CLIENT_ID" ]; then
              echo "âŒ GOOGLE_CLIENT_ID í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              exit 1
            fi
            echo "âœ… ì£¼ìš” í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ"
            
            # ê¸°ì¡´ ë¡œê·¸ ë°±ì—…
            if [ -f app.log ]; then
              LOG_SIZE=$(stat -c%s app.log 2>/dev/null || echo 0)
              if [ "$LOG_SIZE" -gt 1048576 ]; then  # 1MB ì´ìƒ
                echo "ğŸ“„ ê¸°ì¡´ ë¡œê·¸ ë°±ì—… ì¤‘..."
                mv app.log "app.log.$(date +%Y%m%d_%H%M%S)"
              fi
            fi
            
            # ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
            echo "ğŸš€ ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì¤‘..."
            echo "ğŸ“‹ ì‹¤í–‰ ëª…ë ¹ì–´: nohup java -jar $JAR_FILE"
            nohup java -jar "$JAR_FILE" > app.log 2>&1 &
            NEW_PID=$!
            
            echo "ğŸ†” ìƒˆ í”„ë¡œì„¸ìŠ¤ PID: $NEW_PID"
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ í™•ì¸
            echo "â³ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ í™•ì¸ ì¤‘..."
            sleep 5
            
            # PID í™•ì¸
            if ! kill -0 "$NEW_PID" 2>/dev/null; then
              echo "âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹¤íŒ¨ - í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œë¨"
              echo "ğŸ” ìµœê·¼ ë¡œê·¸ í™•ì¸:"
              tail -20 app.log
              exit 1
            fi
            
            # ì¶”ê°€ ëŒ€ê¸° ë° í™•ì¸
            echo "â³ ì• í”Œë¦¬ì¼€ì´ì…˜ ì™„ì „ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
            sleep 10
            
            if pgrep -f 'java.*Haru-Mail-Backend' > /dev/null; then
              echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ìƒ ì‹œì‘ë¨"
              echo "ğŸ” í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ Java í”„ë¡œì„¸ìŠ¤:"
              pgrep -f 'java.*Haru-Mail-Backend' -l
            else
              echo "âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹¤íŒ¨"
              echo "ğŸ” í˜„ì¬ Java í”„ë¡œì„¸ìŠ¤ í™•ì¸:"
              pgrep -f 'java' -l || echo "ì‹¤í–‰ ì¤‘ì¸ Java í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
              echo "ğŸ” ìµœê·¼ ë¡œê·¸ í™•ì¸:"
              tail -30 app.log
              exit 1
            fi
            
            # ë¡œê·¸ í™•ì¸
            echo "ğŸ“‹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ í™•ì¸ ì¤‘..."
            if [ -f app.log ]; then
              echo "ğŸ” ìµœê·¼ ë¡œê·¸ (ë§ˆì§€ë§‰ 10ì¤„):"
              tail -10 app.log
              
              # ì—ëŸ¬ ë¡œê·¸ í™•ì¸
              if grep -i "error\|exception\|failed" app.log | tail -5; then
                echo "âš ï¸ ë¡œê·¸ì—ì„œ ì—ëŸ¬ ë°œê²¬ë¨ (ìœ„ ë‚´ìš© ì°¸ê³ )"
              else
                echo "âœ… ë¡œê·¸ì—ì„œ ì‹¬ê°í•œ ì—ëŸ¬ ë°œê²¬ë˜ì§€ ì•ŠìŒ"
              fi
            else
              echo "âš ï¸ ë¡œê·¸ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            fi
            
            # Caddy ì„œë²„ ì¬ì‹œì‘
            echo "ğŸ” Caddy ì„œë²„ ì¬ì‹œì‘ ì¤‘..."
            if sudo systemctl restart caddy; then
              echo "âœ… Caddy ì„œë²„ ì¬ì‹œì‘ ì™„ë£Œ"
              # Caddy ìƒíƒœ í™•ì¸
              if sudo systemctl is-active caddy >/dev/null 2>&1; then
                echo "âœ… Caddy ì„œë²„ ì •ìƒ ì‹¤í–‰ ì¤‘"
              else
                echo "âš ï¸ Caddy ì„œë²„ ìƒíƒœ í™•ì¸ í•„ìš”"
                sudo systemctl status caddy --no-pager -l
              fi
            else
              echo "âŒ Caddy ì„œë²„ ì¬ì‹œì‘ ì‹¤íŒ¨"
              sudo systemctl status caddy --no-pager -l
              exit 1
            fi
            
            # ë°°í¬ ì™„ë£Œ ë©”ì‹œì§€
            echo ""
            echo "ğŸ‰ ===== ë°°í¬ ì™„ë£Œ ====="
            echo "ğŸ“… ì™„ë£Œ ì‹œê°„: $(date)"
            echo "ğŸ†” ì• í”Œë¦¬ì¼€ì´ì…˜ PID: $(pgrep -f 'java.*Haru-Mail-Backend' || echo 'PID í™•ì¸ ì‹¤íŒ¨')"
            echo "ğŸ“Š ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: $(free -h | grep Mem)"
            echo "ğŸ’¾ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰: $(df -h ~ | tail -1)"
            echo "ğŸ”— ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸: ~/Haru-Mail-Backend/app.log"
            echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REDIRECT_URI: ${{ secrets.GOOGLE_REDIRECT_URI }}
          SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
          SPRING_DATASOURCE_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
